<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>АВТОРИЗАЦИЯ: ОПЕРАЦИЯ "ОМЕГА"</title>
    <style>
        :root {
            --main-color: #0f0; --accent-color: #0ff; --danger-color: #f00;
            --warn-color: #ff0; --info-color: #0bf; --bg-color: #020402;
            --border-color: rgba(0, 255, 0, 0.3);
            --glow-main: 0 0 5px var(--main-color), 0 0 10px var(--main-color);
            --glow-accent: 0 0 5px var(--accent-color), 0 0 10px var(--accent-color);
            --glow-danger: 0 0 7px var(--danger-color), 0 0 12px var(--danger-color);
        }
        body, html {
            margin: 0; padding: 0; background: black; color: var(--main-color);
            font-family: 'Consolas', 'Courier New', Courier, monospace; height: 100%; overflow: hidden;
            text-shadow: 0 0 2px var(--main-color);
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(rgba(0, 255, 0, 0.1) 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.3; pointer-events: none; z-index: -1;
        }
        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0) 0, rgba(0,0,0,0) 1px, rgba(255,255,255,0.05) 2px, rgba(255,255,255,0.05) 3px);
            animation: scanline 4s linear infinite; pointer-events: none; z-index: 1001;
        }
        @keyframes scanline { 0% { background-position: 0 0; } 100% { background-position: 0 100px; } }
        #main-container {
            height: 100vh; width: 100vw; display: flex; align-items: center;
            justify-content: center; flex-direction: column; overflow-y: auto;
            padding: 40px 20px; box-sizing: border-box;
        }
        .content-wrapper { width: 100%; max-width: 900px; }
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000;
            display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.8s ease-out;
        }
        #preloader-text { font-size: 16px; text-align: left; white-space: pre; border-right: 2px solid var(--main-color); animation: blink 0.7s step-end infinite; }
        @keyframes blink { from, to { border-color: transparent; } 50% { border-color: var(--main-color); } }

        .stage, #dialogue-box, #final-screen {
            display: none; flex-direction: column; align-items: center; text-align: center;
            padding: 30px; background-color: rgba(5, 10, 5, 0.9); border: 1px solid var(--border-color);
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.2); margin: 20px; backdrop-filter: blur(2px);
        }
        .fade-in { opacity: 0; transition: opacity 1s ease-in-out; }
        .visible { opacity: 1; }

        #dialogue-text { margin: 15px 0; min-height: 120px; font-size: 18px; line-height: 1.7; cursor: pointer; color: #d9ffda; }
        #guide-name { font-size: 22px; color: var(--accent-color); align-self: flex-start; text-shadow: var(--glow-accent); }
        .glitch-text {
            color: var(--main-color); text-shadow: 1px 1px var(--danger-color), -1px -1px var(--info-color);
            font-size: 28px; animation: text-flicker 3s linear infinite;
        }
        @keyframes text-flicker {
          0% { opacity: 0.8; } 2% { opacity: 0.5; } 4% { opacity: 0.9; } 6% { opacity: 0.4; }
          8% { opacity: 1; } 92% { opacity: 1; } 95% { opacity: 0.6; } 97% { opacity: 1; } 100% { opacity: 0.8;}
        }

        p, pre { font-size: 16px; line-height: 1.6; color: #ccc; }
        code { color: var(--accent-color); background-color: #111; padding: 3px 6px; border: 1px solid #333; border-radius: 3px; font-weight: bold; }
        .log-box {
            width: 95%; background: var(--bg-color); border: 1px solid #333; padding: 15px; margin: 15px 0;
            text-align: left; white-space: pre-wrap; max-height: 250px; overflow-y: auto; color: #aaa;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.5); font-family: 'Consolas', 'Courier New', monospace;
        }
        .log-box b { color: var(--warn-color); font-weight: normal; }
        .log-box .danger-text { color: var(--danger-color); font-weight: bold; }
        .log-box .warn-text { color: var(--warn-color); }
        .log-box .info-text { color: var(--info-color); }
        

        #glitch-box {
            width: 95%; background: #050505; border: 1px solid #333; padding: 15px; margin: 15px 0;
            text-align: center; white-space: pre; font-size: 28px; color: var(--main-color);
            letter-spacing: 15px; min-height: 50px; text-shadow: var(--glow-main);
        }
        input {
            margin: 15px 0; padding: 12px; background: #000; color: var(--main-color);
            border: 1px solid var(--main-color); width: 100%; max-width: 400px;
            font-size: 16px; text-align: center; font-family: 'Consolas', 'Courier New', monospace; transition: all 0.3s;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.8);
        }
        input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); }
        button {
            margin: 10px 5px; padding: 12px 25px; background: transparent; color: var(--main-color);
            border: 1px solid var(--main-color); cursor: pointer; font-size: 16px;
            font-family: 'Consolas', 'Courier New', monospace; transition: all 0.2s;
            text-shadow: 0 0 5px var(--main-color);
        }
        button:hover { background: var(--main-color); color: black; box-shadow: var(--glow-main); transform: translateY(-3px); text-shadow: none; }
        button:active { transform: translateY(-1px); }
        button.danger { border-color: var(--danger-color); color: var(--danger-color); text-shadow: 0 0 5px var(--danger-color); }
        button.danger:hover { background: var(--danger-color); color: white; box-shadow: var(--glow-danger); text-shadow: none;}
        button:disabled { background: #333; border-color: #555; cursor: not-allowed; transform: none; color: #888; text-shadow: none;}
        .processing-bar { width: 100%; background: #222; border: 1px solid #444; margin-top: 20px; display: none; }
        .processing-bar-fill { width: 0%; height: 10px; background: var(--accent-color); transition: width 1.5s ease-out; box-shadow: var(--glow-accent); }

        #dev-console-trigger {
            position: fixed; top: 10px; right: 10px;
            width: 12px; height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer; z-index: 998;
            box-shadow: var(--glow-accent);
            transition: all 0.2s;
            animation: pulse 2s infinite;
        }
        #dev-console-trigger:hover { transform: scale(1.3); }
        @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

        #dev-console {
            display: none; position: fixed; top: 15px; right: 15px;
            width: 250px; background: rgba(10, 20, 10, 0.95);
            border: 1px solid var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            z-index: 999; backdrop-filter: blur(3px);
        }
        #dev-console-header { padding: 10px; text-align: center; background: var(--accent-color); color: black; font-weight: bold; cursor: pointer; text-shadow: none; }
        #dev-console-body { padding: 15px; max-height: 300px; overflow-y: auto; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        #dev-console-body.collapsed { max-height: 0; padding: 0 15px; overflow: hidden; }
        #dev-console-body ul { list-style: none; padding: 0; margin: 0; }
        #dev-console-body li a { display: block; padding: 5px; color: var(--main-color); text-decoration: none; transition: background-color 0.2s; }
        #dev-console-body li a:hover { background-color: rgba(0, 255, 255, 0.2); }

        #final-report-container { width: 100%; text-align: left; margin-top: 20px; }
        .report-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px dashed #333; opacity: 0; transform: translateX(-20px); transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.2s; }
        .report-item.visible { opacity: 1; transform: translateX(0); }
        .report-item:hover { background-color: rgba(0, 255, 0, 0.1); }
        .report-item .label { color: var(--accent-color); flex-basis: 40%; }
        .report-item .data { color: var(--main-color); font-weight: bold; flex-basis: 50%; letter-spacing: 1px;}
        .report-item .status { color: #555; flex-basis: 10%; text-align: right; }
        .report-item .status.confirmed { color: var(--main-color); font-weight: bold; text-shadow: var(--glow-main); }
        #final-link { margin-top: 30px; color: white; font-weight: bold; text-decoration: none; font-size: 18px; display: block; padding: 15px 30px; border: 1px solid var(--danger-color); transition: all 0.2s; background: var(--danger-color); box-shadow: var(--glow-danger); }
        #final-link:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--danger-color); }

        .interactive-tool { border: 1px solid var(--accent-color); margin-top: 20px; padding: 15px; width: 95%; background: rgba(0, 20, 20, 0.5); text-align: left; }
        .interactive-tool label { display: block; margin-bottom: 5px; color: var(--accent-color); }
        .interactive-tool input, .interactive-tool pre { width: 100%; box-sizing: border-box; margin: 5px 0 10px 0; text-align: left; }
        .interactive-tool pre { background: #000; padding: 10px; min-height: 40px; color: var(--main-color); border: 1px solid #333;}
        
        #stage16-display { display: flex; justify-content: space-between; width: 95%; padding: 20px; border: 1px solid var(--accent-color); margin: 20px 0; background: #000; font-size: 18px; }
        #stage16-display div { flex-basis: 48%; text-align: left;}
        #stage16-display span { color: var(--warn-color); }
        #stage16-actions { display: flex; flex-wrap: wrap; justify-content: center; margin: 15px 0;}
        #stage16-actions button { flex-basis: 45%; margin: 5px; }
        #stage16-log { width: 95%; min-height: 80px; text-align: left; padding: 10px; background: #050505; border: 1px solid #444; margin-top: 15px; color: #aaa; }
        #stage16-log .log-entry.error { color: var(--danger-color); }
        #stage16-log .log-entry.success { color: var(--accent-color); }
        #stage16-log .log-entry.warn { color: var(--warn-color); }

    </style>
</head>
<body>
    <div id="preloader"><div id="preloader-text"></div></div>

    <!-- DEV CONSOLE & TRIGGER -->
    <div id="dev-console-trigger" onclick="toggleDevConsole()"></div>
    <div id="dev-console">
        <div id="dev-console-header" onclick="collapseDevConsoleBody()">[DEV_CONSOLE]</div>
        <div id="dev-console-body">
            <ul id="dev-nav-list"></ul>
        </div>
    </div>

    <div id="main-container">
        <div class="content-wrapper">
            <div id="dialogue-box" class="fade-in">
                <p id="guide-name">[ИИ-Инструктор "Прометей"]</p>
                <p id="dialogue-text" onclick="skipTypewriter()"></p>
                <button id="dialogue-button">Продолжить</button>
                <div class="processing-bar" id="processing"><div class="processing-bar-fill" id="processing-fill"></div></div>
            </div>

            <!-- Контейнеры для этапов теперь пустые. Контент будет загружен из шаблонов. -->
            <div id="stage1" class="stage fade-in"></div>
            <div id="stage2" class="stage fade-in"></div>
            <div id="stage3" class="stage fade-in"></div>
            <div id="stage4" class="stage fade-in"></div>
            <div id="stage5" class="stage fade-in"></div>
            <div id="stage6" class="stage fade-in"></div>
            <div id="stage7" class="stage fade-in"></div>
            <div id="stage8" class="stage fade-in"></div>
            <div id="stage9" class="stage fade-in"></div>
            <div id="stage10" class="stage fade-in"></div>
            <div id="stage11" class="stage fade-in"></div>
            <div id="stage12" class="stage fade-in"></div>
            <div id="stage13" class="stage fade-in"></div>
            <div id="stage14" class="stage fade-in"></div>
            <div id="stage15" class="stage fade-in"></div>
            <div id="stage16" class="stage fade-in"></div>
            <div id="stage17" class="stage fade-in"></div>
            <div id="final-screen" class="stage fade-in"></div>

        </div>
    </div>
    
    <!-- Шаблоны для всего контента -->
    <template id="stage1-template">
        <h1 class="glitch-text">ЭТАП 1: ПРОБОЙ ПЕРИМЕТРА</h1>
        <p>Ваша первая задача — обойти систему аутентификации эмулятора "Цербера". Проанализируйте лог и восстановите данные для входа: ПОЗЫВНОЙ, ПАРОЛЬ, ТОКЕН.</p>
        <div class="log-box">[01:10] Policy Update: Passwords must combine target name and operation type. Target: AURORA, Operation: BREACH.
[01:11] Login attempt for user 'admin' - FAILED (permission_denied)
[01:12] Login attempt for user 'GHOST' - FAILED (token_mismatch)
[01:13] [SECURITY_EVENT] Token generation failed. Params: [ERR_CODE_PRIMARY_DIGIT=4], [TARGET_SYSTEM_ID=7]. Method: CONCAT.
[01:14] System health check... OK
[01:15] Login attempt for user 'j.smith' - FAILED (bad_pass)</div>
        <input type="text" id="ans1_user" placeholder="ПОЗЫВНОЙ"> <input type="text" id="ans1_pass" placeholder="ПАРОЛЬ"> <input type="text" id="ans1_token" placeholder="ТОКЕН">
        <button onclick="checkStage1()">Войти</button>
    </template>

    <template id="stage2-template">
        <h1 class="glitch-text">ЭТАП 2: АУДИТ ПОДСИСТЕМ "ЦЕРБЕРА"</h1>
        <p>"Цербер" использует устаревшие службы как ловушки. Изучите отчет сканера и введите команду для отключения уязвимой подсистемы.</p>
        <div class="log-box">SERVICE_MODULE             | STATUS  | RECOMMENDED_ACTION
---------------------------|---------|-----------------------------
cerberus.auth.service      | active  | MONITOR
cerberus.core.service      | active  | MONITOR
cerberus.firewall.service  | active  | MONITOR
<span class="danger-text">cerberus.legacy_ftp.service</span>| active  | <span class="danger-text">DISABLE (use 'systemctl')</span>
cerberus.logging.service   | active  | MONITOR</div>
        <input type="text" id="answer2" placeholder="Введите команду..."> <button onclick="checkStage2()">Выполнить</button>
    </template>

    <template id="stage3-template">
        <h1 class="glitch-text">ЭТАП 3: АНАЛИЗ ДАМПА ПАМЯТИ</h1>
        <p>"Цербер" прячет ключи шифрования в оперативной памяти. Найдите ключ активной сессии (`SESSION.KEY`), чтобы обойти его сканеры. Игнорируйте мусорные данные.</p>
        <div class="log-box">...
01B0: 44 45 42 55 47 5f 4b 45 | DEBUG_KE (DEPRECATED)
01C0: 59 3a 20 30 78 44 45 41 | Y: 0xDEA
01D0: 44 0a 4f 4c 44 5f 4b 45 | D.OLD_KE
01E0: 59 3a 20 30 78 31 32 33 | Y: 0x123
01F0: 34 0a 54 45 53 54 5f 4b | 4.TEST_K (INACTIVE)
0200: 45 59 3a 20 <b>0x4142</b> | EY: <b>0x4142</b>
0210: <b>4344</b> 0a 53 45 53 53 49 | <b>CD</b>.SESSI
0220: 4f 4e 2e 4b 45 59 20 20 | ON.KEY  (<b>ACTIVE</b>)
...</div>
        <input type="text" id="answer3" placeholder="Ключ доступа (ACCESS_KEY)"> <button onclick="checkStage3()">Извлечь</button>
    </template>

    <template id="stage4-template">
        <h1 class="glitch-text">ЭТАП 4: ВОССТАНОВЛЕНИЕ ПОЗЫВНОГО</h1>
        <p>Ваш цифровой след зашумлен помехами "Цербера". Выделите из шума свой позывной, чтобы подтвердить личность для дальнейшего продвижения.</p>
        <div id="glitch-box"></div>
        <input type="text" id="answer4" placeholder="Скрытое слово"> <button onclick="checkStage4()">Расшифровать</button>
    </template>

    <template id="stage5-template">
        <h1 class="glitch-text">ЭТАП 5: ПОИСК УЗЛА ЭКСФИЛЬТРАЦИИ</h1>
        <p>"Цербер" использует скрытые узлы для отправки отчетов. Проанализируйте сетевой трафик и определите IP-адрес, куда был отправлен аномальный пакет по порту 31337.</p>
        <div class="log-box">TIME | SRC_IP        | DST_IP          | PROTO | LEN  | INFO
...
13:01| 192.168.1.50  | 8.8.8.8         | DNS   | 74   | Standard query A? google.com
13:01| 192.168.1.52  | 198.51.100.12   | HTTPS | 1500 | [SYN]
13:02| 192.168.1.50  | 218.45.192.88   | TCP   | 879121 | Port 31337 -> 80 [PSH, ACK]
13:03| 192.168.1.55  | 192.168.1.1     | HTTP  | 321  | GET /status.html
13:04| 192.168.1.52  | 192.168.1.1     | ARP   | 42   | Who has 192.168.1.50?
...</div>
        <input type="text" id="answer5" placeholder="Destination IP"> <button onclick="checkStage5()">Определить</button>
    </template>

    <template id="stage6-template">
        <h1 class="glitch-text">ЭТАП 6: АНАЛИЗ ШИФРОГРАММЫ</h1>
        <p>Перехвачено сообщение "Цербера", зашифрованное сдвигом (шифр Цезаря). Расшифруйте его, чтобы получить кодовую фразу.</p>
        <div class="log-box">ENCRYPTED PAYLOAD: "olssv-dvysk-vtlnh-alza"
SECURITY LEVEL: 7
ANALYSIS: The encryption key (shift value) corresponds to the security level number.</div>
        <div class="interactive-tool">
            <label for="tool-input-6-text">[УТИЛИТА: ДЕШИФРАТОР СДВИГА]</label>
            <input type="text" id="tool-input-6-text" placeholder="Зашифрованный текст...">
            <label for="tool-input-6-key">Ключ сдвига:</label>
            <input type="number" id="tool-input-6-key" placeholder="Числовой ключ...">
            <button onclick="processStage6Tool()">Обработать</button>
            <label style="margin-top:10px;">Результат:</label>
            <pre id="tool-output-6"></pre>
        </div>
        <input type="text" id="answer6" placeholder="Введите расшифрованную фразу"> <button onclick="checkStage6()">Подтвердить</button>
    </template>

    <template id="stage7-template">
        <h1 class="glitch-text">ЭТАП 7: АНАЛИЗ ФАЙЛА КОНФИГУРАЦИИ</h1>
        <p>Имя файла известно. Внутри — конфигурация одного из модулей "Цербера". Соберите пароль по умолчанию из переменных согласно формату.</p>
        <div class="log-box"># Cerberus Module Config v2.1 // "Project Chimera"
# All values are case-sensitive.
[variables]
prefix = "chimera"
secret_code = "lock"
year = "2077"
# Format for default password generation: ${prefix}-${year}-${secret_code}
[settings]
listen_port = 8443
encryption = "AES-GCM"</div>
        <input type="text" id="answer7" placeholder="Сконструированный пароль"> <button onclick="checkStage7()">Собрать</button>
    </template>

    <template id="stage8-template">
        <h1 class="glitch-text">ЭТАП 8: НЕЙТРАЛИЗАЦИЯ УГРОЗЫ</h1>
        <p>"Цербер" инициировал атаку, вызвавшую перегрев ядра. Проанализируйте телеметрию и выберите действие, устраняющее ПЕРВОПРИЧИНУ проблемы, а не её следствие.</p>
        <div class="log-box">[15:10:01] SYS_MONITOR: Network traffic on eth0 at 998Mbps. Status: DDoS DETECTED.
[15:10:02] SYS_MONITOR: CPU load at 100%. Cause: Network stack processing flood.
[15:10:03] SYS_MONITOR: Main coolant pump pressure at 5%. Status: FAILURE. Core temp rising to critical.
[15:10:04] SYS_MONITOR: Reserve coolant tank pressure at 100%. Status: STANDBY.</div>
        <div>
            <button class="danger" onclick="checkStage8('REBOOT_SERVER')">Аварийная Перезагрузка</button>
            <button onclick="checkStage8('RESERVE_COOLANT')">Активировать Резервное Охлаждение</button>
            <button onclick="checkStage8('ISOLATE_NETWORK')">Изолировать Сетевой Интерфейс (eth0)</button>
        </div>
    </template>

    <template id="stage9-template">
        <h1 class="glitch-text">ЭТАП 9: АНАЛИЗ СКРИПТА "ЦЕРБЕРА"</h1>
        <p>Мы перехватили скрипт-инжектор "Цербера". Определите имя ключевой функции, которая выполняет и внедрение, и маскировку процесса.</p>
        <div class="log-box">function find_process(p_name) {
  // ... process search logic ...
  return process_handle;
}
// This function combines injection and cloaking
function inject_and_hide(process, file) {
  target = find_process(process);
  if (target) {
    inject_dll(target, file);   // Step 1: Inject
    cloak_process_id(target); // Step 2: Hide
  }
}
function log_telemetry(message) {
  // ... logging logic ...
}</div>
        <input type="text" id="answer9" placeholder="Название функции..."> <button onclick="checkStage9()">Идентифицировать</button>
    </template>

    <template id="stage10-template">
        <h1 class="glitch-text">ЭТАП 10: ГЛУБОКИЙ АУДИТ СИСТЕМЫ</h1>
        <p>"Цербер" изменил системный файл. Изучите отчет сканера целостности и определите имя файла, который не прошел критическую проверку (статус FAILED).</p>
        <div class="log-box">[SYSTEM INTEGRITY SCAN REPORT - PID: 7712]
[14:30:01] Scanning C:\Windows\System32...
[14:30:02] Checking kernel32.dll... [OK]
[14:30:03] Checking gdi32.dll... [OK]
[14:30:04] Checking svchost.exe... <span class="warn-text">[WARNING]</span> Hash mismatch. Reason: Legitimate update. PRIORITY: LOW.
[14:30:05] Checking user32.dll... <span class="danger-text">[FAILED]</span> PRIORITY: CRITICAL.
    LIVE_HASH:    9a9f7d...c5d88
    EXPECTED_HASH: 5f0b1a...8d3e9
[14:30:06] Checking ntdll.dll... [OK]
[14:30:07] Checking ntd11.dll... <span class="info-text">[UNKNOWN_FILE]</span> Not in system manifest.
[14:30:08] ...
[14:30:09] SCAN COMPLETE. 1 failure(s), 1 warning(s) detected.</div>
        <input type="text" id="answer10" placeholder="Имя скомпрометированного файла..."> <button onclick="checkStage10()">Обнаружить</button>
    </template>

    <template id="stage11-template">
        <h1 class="glitch-text">ЭТАП 11: ДЕКОДИРОВАНИЕ HEX</h1>
        <p>"Цербер" передаёт команды в виде HEX-строк. Декодируйте перехваченную команду, чтобы узнать следующий пароль.</p>
        <p>Скопируйте эту строку: <code>4F4D4547412D4C4F434B444F574E</code></p>
        <div class="interactive-tool">
            <label for="tool-input-11">[УТИЛИТА: HEX -> ASCII КОНВЕРТЕР]</label>
            <input type="text" id="tool-input-11" placeholder="Вставьте HEX-строку сюда...">
            <button onclick="processStage11Tool()">Обработать</button>
            <label style="margin-top:10px;">Результат:</label>
            <pre id="tool-output-11"></pre>
        </div>
        <input type="text" id="answer11" placeholder="Введите декодированную команду/пароль"> <button onclick="checkStage11()">Подтвердить</button>
    </template>

    <template id="stage12-template">
        <h1 class="glitch-text">ЭТАП 12: ПОИСК УЯЗВИМОСТИ ДОСТУПА</h1>
        <p>Для повышения привилегий "Цербер" ищет файлы с неверно настроенными правами. Найдите исполняемый файл с SUID-битом ('s'), который позволяет запуск от имени root.</p>
        <div class="log-box">PERMS      OWNER  GROUP  PATH
-rw-r--r-- root   root   /etc/passwd
-rwxr-xr-x root   root   /bin/bash
-rwsr-xr-x root   root   /opt/aurora/diag_tool
-rwxr-x--- root   adm    /var/log/syslog</div>
        <input type="text" id="answer12" placeholder="Полный путь к файлу"> <button onclick="checkStage12()">Найти</button>
    </template>

    <template id="stage13-template">
        <h1 class="glitch-text">ЭТАП 13: ВОССТАНОВЛЕНИЕ ДАННЫХ</h1>
        <p>Журнал транзакций БД поврежден атакой. Найдите значение (`value`) ключа доступа, которое было успешно записано в последней подтвержденной (`COMMIT; -- OK`) транзакции.</p>
        <div class="log-box">[18:01] BEGIN; INSERT ... FAILED
[18:02] BEGIN; UPDATE users SET last_login=now() WHERE id=1; COMMIT; -- OK
[18:03] BEGIN; INSERT INTO secrets (key, value) VALUES ('backup_key', 'backup_access_key_Alpha7!'); COMMIT; -- OK
[18:04] BEGIN; DELETE FROM logs; ROLLBACK; -- CANCELED</div>
        <input type="text" id="answer13" placeholder="Значение из лога"> <button onclick="checkStage13()">Восстановить</button>
    </template>

    <template id="stage14-template">
        <h1 class="glitch-text">ЭТАП 14: РЕВЕРС-ИНЖИНИРИНГ</h1>
        <p>Проанализируйте фрагмент ассемблерного кода. Определите, какое значение будет в регистре `EAX` после выполнения всех команд. Ответ дайте в десятичной системе.</p>
        <div class="log-box">_init:
  MOV EAX, 12      ; EAX = 12
_calc_offset:
  ADD EAX, 3       ; EAX = 15
  SUB EAX, 5       ; EAX = 10
_scale_factor:
  IMUL EAX, 4      ; EAX = 40 (Integer Multiply)
_finalize:
  SHL EAX, 1       ; EAX = 80 (Shift Left by 1 bit, equals EAX * 2)
; EAX = ?</div>
        <input type="text" id="answer14" placeholder="Финальное значение EAX (десятичное)"> <button onclick="checkStage14()">Вычислить</button>
    </template>

    <template id="stage15-template">
        <h1 class="glitch-text">ЭТАП 15: КОРРЕЛЯЦИЯ ЛОГОВ</h1>
        <p>Инсайдер использовал jump-хост для маскировки. Проследите его путь через системы, сопоставляя IP-адреса, и определите имя пользователя (`user`).</p>
        <div class="log-box" style="border-color: var(--warn-color);"><b>VPN.LOG</b><br>...<br>[13:01:55] User 'j.holloway' authenticated. Assigned internal IP: 10.254.1.18<br>[13:01:59] User 'm.stark' authenticated. Assigned internal IP: 10.254.1.22<br>...</div>
        <div class="log-box"><b>JUMP_HOST.LOG</b><br>...<br>[13:02:10] Inbound connection from 10.254.1.18 accepted.<br>[INFO] Source IP for outbound connections: 10.10.10.5<br>...</div>
        <div class="log-box"><b>DATABASE.LOG</b><br>...<br>[13:02:16] Connection from 10.10.10.5. Query: 'DUMP TABLE users_private'. UNAUTHORIZED.<br>[13:02:20] Connection from 192.168.1.10. Query: 'SELECT status'. OK.<br>...</div>
        <input type="text" id="answer15" placeholder="Имя пользователя инсайдера"> <button onclick="checkStage15()">Определить</button>
    </template>

    <template id="stage16-template">
        <h1 class="glitch-text">ЭТАП 16: ПРОТОКОЛ "ЖНЕЦ" v2.0</h1>
        <p>Адаптивный агент "Цербера" активен. Управляйте энергией, анализируйте уязвимости и нейтрализуйте его.</p>
        <div id="stage16-display">
            <div>
                АГЕНТ: <span id="agent-status">ЗАГРУЗКА...</span><br>
                ЦЕЛОСТНОСТЬ: <span id="agent-health">100%</span>
            </div>
            <div>
                ОПЕРАТОР: <br>
                ЭНЕРГИЯ: <span id="player-energy">100</span>
            </div>
        </div>
        <div id="stage16-actions">
            <button id="action-overload" onclick="performAgentAction('overload')">Перегрузка щита [-30Э]</button>
            <button id="action-analyze" onclick="performAgentAction('analyze')">Анализ уязвимости [-10Э]</button>
            <button id="action-execute-alpha" onclick="performAgentAction('execute_alpha')">Эксплойт: Альфа [-25Э]</button>
            <button id="action-execute-beta" onclick="performAgentAction('execute_beta')">Эксплойт: Бета [-25Э]</button>
            <button id="action-recharge" onclick="performAgentAction('recharge')">Перезарядка [+15Э]</button>
            <button id="action-purge" class="danger" onclick="performAgentAction('purge')">Очистка системы</button>
        </div>
        <div id="stage16-log"></div>
    </template>

    <template id="stage17-template">
        <h1 class="glitch-text">ФИНАЛ: ФОРМИРОВАНИЕ КЛЮЧА ДОСТУПА</h1>
        <p>Вы собрали все части головоломки. Скомбинируйте ключевые данные для генерации мастер-ключа, который даст вам доступ к реальному узлу "Авроры".</p>
        <p>Формат: [Ключ из памяти]-[IP "Цербера"]-[Команда HEX]-[Имя инсайдера]</p>
        <input type="text" id="answer17" placeholder="0xXXXX-XXX.XX.XXX.XX-XXXX-XXXX-XXXXXX-X.xxxxxxxx"> <button class="danger" onclick="checkStage17()">СГЕНЕРИРОВАТЬ КЛЮЧ</button>
    </template>
    
    <template id="final-screen-template">
        <h1 class="glitch-text" style="color: var(--accent-color);">АТТЕСТАЦИЯ ПРОЙДЕНА</h1>
        <p style="color: #0ff; font-size: 18px;">ОЦЕНКА: ОТЛИЧНО. ДОПУСК К ОПЕРАЦИИ "ОМЕГА" ПОЛУЧЕН.</p>
        <p>Вы успешно прошли симуляцию и доказали свою компетентность. Данные, собранные вами, являются ключом к реальной системе.<br><b>ВНИМАНИЕ. Вам предоставляется одноразовое окно для подключения к главному узлу "Авроры".</b></p>
        <p>Не подведите нас, хакер. Протокол "Омега" должен быть нейтрализован любой ценой.</p>
        <div id="final-report-container">
            <h3 style="color:var(--warn-color); text-align: left; width:100%; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">ИТОГОВЫЙ БРИФИНГ:</h3>
        </div>
         <a id="final-link" href="#" target="_blank">ПОДКЛЮЧИТЬСЯ К УЗЛУ "АВРОРА"</a>
    </template>

    <script>
        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let currentStep = 0;
        const finalUrl = "https://invasion-omega.github.io/ProtectServer/"; // ССЫЛКА НА ОСНОВНОЙ КВЕСТ
        let typewriterInterval, glitchInterval;
        let isTyping = false;
        const questData = {};
        
        // --- State for Stage 16 ---
        let gameState = {
            agent: {
                status: 'SHIELDED', // SHIELDED, VULNERABLE
                health: 100,
                adaptation: 'NONE' // NONE, ALPHA, BETA
            },
            player: {
                energy: 100
            },
            gameOver: false
        };

        // --- Диалоги Инструктора "Прометей" ---
        const dialogues = [
            /* 0*/ "Инициализация симуляции... Я - ИИ-Инструктор 'Прометей'. Это ваша финальная аттестация перед операцией 'Омега'. Ваша цель - корпорация 'Аврора'. Докажите, что вы готовы к встрече с их защитой - ИИ 'Цербер'.",
            /* 1*/ "Допуск подтвержден. Начнем. 'Цербер' использует многоуровневую аутентификацию. Ваша первая задача - обойти симуляцию его внешнего периметра. Проанализируйте лог.",
            /* 2*/ "Доступ получен. Этап два: саботаж. 'Цербер' использует устаревшие службы как ловушки для невнимательных. Ликвидируйте уязвимость, следуя отчету сканера.",
            /* 3*/ "Подсистема деактивирована. Хорошо. Теперь сложнее: 'Цербер' прячет ключи в оперативной памяти. Сосредоточьтесь на активном ключе сессии, чтобы обмануть его сканеры.",
            /* 4*/ "Ключ извлечен. Следующий тест — ваше самоопределение в цифровом шуме. 'Цербер' попытается стереть ваш след. Подтвердите свой позывной.",
            /* 5*/ "Идентификация пройдена. 'Призрак' в машине. Теперь сетевой анализ. 'Цербер' отправляет отчеты на скрытые узлы. Найдите точку эксфильтрации данных.",
            /* 6*/ "IP-адрес идентифицирован. Мы перехватили зашифрованный контейнер. Это не просто данные, а команда. Расшифруйте ее. Ключ скрыт в метаданных.",
            /* 7*/ "Фраза восстановлена. В 80% случаев взлом — результат халатности. Изучите файл конфигурации и соберите пароль из компонентов, как это сделал бы ленивый разработчик.",
            /* 8*/ "Пароль собран. Внимание, симуляция контратаки! 'Цербер' атакует систему. Не поддавайтесь панике, ищите корень проблемы, а не боритесь с симптомами.",
            /* 9*/ "Система стабилизирована. Решение верное. Теперь анализ кода. Мы перехватили инжектор 'Цербера'. Найдите его ключевую исполняющую функцию.",
            /*10*/ "Функция идентифицирована. После внедрения 'Цербер' изменяет системные файлы. Проведите глубокий аудит целостности и найдите критическую аномалию.",
            /*11*/ "Компрометация обнаружена. Канал управления 'Цербера' передает команды в HEX-формате. Декодируйте перехваченное сообщение.",
            /*12*/ "Команда восстановлена. Теперь они попытаются повысить свои привилегии. Для этого им нужен файл с особыми правами доступа. Проведите аудит.",
            /*13*/ "Уязвимый файл найден. Атака также повредила базу данных. Восстановите последние валидные данные из журнала транзакций. Они могут быть важны.",
            /*14*/ "Данные восстановлены. Мы получили доступ к низкоуровневым инструкциям процессора. Рассчитайте результат их микрооперации, чтобы предсказать действия 'Цербера'.",
            /*15*/ "Результат верен. Финальный аналитический этап. Инсайдер использует посредника для маскировки. Проведите полную корреляцию логов, чтобы вскрыть его личность.",
            /*16*/ "Личность установлена. Финальный практический тест. Против вас адаптивный боевой агент. Управляйте ресурсами и тактикой, чтобы выжить и победить.",
            /*17*/ "Агент нейтрализован. Вы собрали все фрагменты информации. Соберите из них мастер-ключ. Это ваш пропуск в реальную сеть 'Авроры'.",
            /*18*/ "Ключ принят. Симуляция пройдена. Вы готовы. Окно для атаки открыто. Подключайтесь к узлу 'Аврора' и нейтрализуйте протокол 'Омега'. Удачи, Призрак."
        ];
        
        function populateQuestData(upToStage) { const fullData = { '1': { user: 'GHOST', pass: 'AURORA_BREACH', token: '47' }, '3': { memoryKey: '0x41424344' }, '4': { shieldName: 'GHOST' }, '5': { attackerIP: '218.45.192.88' }, '6': { decodedPhrase: 'hello-world-omega-test' }, '7': { constructedPass: 'chimera-2077-lock' }, '10': { compromisedFile: 'user32.dll' }, '11': { hexCommand: 'OMEGA-LOCKDOWN' }, '12': { vulnerableFile: '/opt/aurora/diag_tool' }, '13': { sqlValue: 'backup_access_key_Alpha7!' }, '14': { asmResult: 80 }, '15': { attackerUser: 'j.holloway' } }; for(let i = 1; i <= upToStage; i++){ if(fullData[i]) Object.assign(questData, fullData[i]); } }
        function jumpToStage(stageNum) { stopGlitchEffect(); populateQuestData(stageNum - 1); currentStep = stageNum - 1; advanceState(); }
        
        function toggleDevConsole() {
            const consoleEl = document.getElementById('dev-console');
            const triggerEl = document.getElementById('dev-console-trigger');
            if (consoleEl.style.display === 'block') {
                consoleEl.style.display = 'none';
                triggerEl.style.display = 'block';
            } else {
                consoleEl.style.display = 'block';
                triggerEl.style.display = 'none';
            }
        }

        function collapseDevConsoleBody() {
             document.getElementById('dev-console-body').classList.toggle('collapsed');
        }

        function initDevConsole() {
            const navList = document.getElementById('dev-nav-list');
            for (let i = 1; i <= 17; i++) {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" onclick="jumpToStage(${i})">Этап ${i}</a>`;
                navList.appendChild(li);
            }
            const finalLi = document.createElement('li');
            finalLi.innerHTML = `<a href="#" onclick="jumpToFinalScreen()" style="color:var(--danger-color);">Финал</a>`;
            navList.appendChild(finalLi);
        }

        function jumpToFinalScreen() { stopGlitchEffect(); populateQuestData(17); currentStep = 18; showFinalScreen(); }
        function showProcessing(callback) { const bar = document.getElementById('processing'); const fill = document.getElementById('processing-fill'); bar.style.display = 'block'; fill.style.width = '0%'; setTimeout(() => { fill.style.width = '100%'; }, 100); setTimeout(() => { bar.style.display = 'none'; callback(); }, 1600); }
        function typewriter(element, text, callback) { let i = 0; element.innerHTML = ""; isTyping = true; const btn = document.getElementById('dialogue-button'); if(btn) btn.disabled = true; clearInterval(typewriterInterval); typewriterInterval = setInterval(() => { if (i < text.length) { element.innerHTML += text.charAt(i); i++; } else { isTyping = false; clearInterval(typewriterInterval); if(btn) btn.disabled = false; if(callback) callback(); } }, 20); }
        function skipTypewriter() { if (!isTyping) return; isTyping = false; clearInterval(typewriterInterval); const btn = document.getElementById('dialogue-button'); const targetText = dialogues[currentStep]; document.getElementById('dialogue-text').innerHTML = targetText; if (btn) btn.disabled = false; }
        function stopGlitchEffect() { clearInterval(glitchInterval); }

        function hideAll() {
            stopGlitchEffect();
            document.querySelectorAll('.stage, #dialogue-box').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('visible');
            });
        }

        function showDialogue(index) {
            hideAll();
            const box = document.getElementById('dialogue-box');
            box.style.display = 'flex';
            setTimeout(() => {
                box.classList.add('visible');
                typewriter(document.getElementById('dialogue-text'), dialogues[index] || "");
            }, 10);
        }

        function showStage(id) {
            hideAll();
            const stage = document.getElementById(id);
            const template = document.getElementById(id + '-template');
            
            if (template) {
                stage.innerHTML = template.innerHTML;
            } else {
                console.error(`Template not found for ${id}`);
                stage.innerHTML = `<h1 class="glitch-text">ERROR: STAGE CONTENT FAILED TO LOAD</h1>`;
            }

            stage.style.display = 'flex';
            setTimeout(() => { stage.classList.add('visible'); }, 10);

            if (id === 'stage4') startGlitchEffect();
            if (id === 'stage16') initStage16();
        }
        
        function advanceState() {
            currentStep++;
            const dialogueButton = document.getElementById('dialogue-button');
            if (currentStep <= 17) {
                showDialogue(currentStep);
                dialogueButton.onclick = () => showProcessing(() => showStage('stage' + currentStep));
            } else {
                showDialogue(18);
                dialogueButton.onclick = () => showProcessing(() => jumpToFinalScreen());
            }
        }
        
        function handleCorrectAnswer() { showProcessing(() => advanceState()); }
        
        function startSimulation() {
            currentStep = 0;
            showDialogue(0);
            document.getElementById('dialogue-button').onclick = advanceState;
        }

        function checkStage1() { if(document.getElementById('ans1_user').value.trim().toUpperCase() === 'GHOST' && document.getElementById('ans1_pass').value.trim().toUpperCase() === 'AURORA_BREACH' && document.getElementById('ans1_token').value.trim() === '47') { questData.user = 'GHOST'; questData.pass = 'AURORA_BREACH'; questData.token = '47'; handleCorrectAnswer(); } else { alert("ДАННЫЕ НЕВЕРНЫ. 'ЦЕРБЕР' УСИЛИВАЕТ ЗАЩИТУ."); } }
        function checkStage2() { if(document.getElementById('answer2').value.trim().toLowerCase() === 'systemctl disable cerberus.legacy_ftp.service') {handleCorrectAnswer();} else { alert('НЕВЕРНАЯ КОМАНДА. ПОДСИСТЕМА ВСЕ ЕЩЕ АКТИВНА.'); }}
        function checkStage3() { const answer = document.getElementById('answer3').value.trim().toUpperCase(); if(answer === '0X41424344') { questData.memoryKey = answer; handleCorrectAnswer(); } else { alert('НЕВЕРНЫЙ КЛЮЧ. ПРОВЕРЬТЕ АДРЕС В ДАМПЕ.'); } }
        function checkStage4() { const answer = document.getElementById('answer4').value.trim().toUpperCase(); if(answer === 'GHOST') { questData.shieldName = answer; handleCorrectAnswer(); } else { alert("ОШИБКА РАСПОЗНАВАНИЯ. 'ЦЕРБЕР' МАСКИРУЕТ СИГНАЛ."); } }
        function checkStage5() { const answer = document.getElementById('answer5').value.trim(); if(answer === '218.45.192.88') { questData.attackerIP = answer; handleCorrectAnswer(); } else { alert('IP-АДРЕС НЕВЕРЕН. УТЕЧКА ПРОДОЛЖАЕТСЯ.'); } }
        function checkStage6() { if(document.getElementById('answer6').value.trim().toLowerCase() === 'hello-world-omega-test') { questData.decodedPhrase = 'hello-world-omega-test'; handleCorrectAnswer(); } else { alert('ДЕКОДИРОВАНИЕ НЕУДАЧНО ИЛИ ФРАЗА НЕВЕРНА.'); } }
        function checkStage7() { if(document.getElementById('answer7').value.trim() === 'chimera-2077-lock') { questData.constructedPass = 'chimera-2077-lock'; handleCorrectAnswer(); } else { alert('НЕВЕРНЫЙ ПАРОЛЬ. ПРОВЕРЬТЕ ФОРМАТ И ПЕРЕМЕННЫЕ.'); } }
        function checkStage8(action) { if(action === 'ISOLATE_NETWORK') handleCorrectAnswer(); else { alert('НЕВЕРНОЕ РЕШЕНИЕ. БОРЬБА СО СЛЕДСТВИЕМ, А НЕ С ПРИЧИНОЙ, ПРИВЕЛА К КРАХУ СИСТЕМЫ. ПЕРЕЗАПУСК...'); location.reload(); } }
        function checkStage9() { if(document.getElementById('answer9').value.trim().toLowerCase() === 'inject_and_hide') { handleCorrectAnswer(); } else { alert('ИДЕНТИФИКАЦИЯ НЕ ПРОЙДЕНА.'); } }
        function checkStage10() { const answer = document.getElementById('answer10').value.trim().toLowerCase(); if(answer === 'user32.dll') { questData.compromisedFile = 'user32.dll'; handleCorrectAnswer(); } else { alert('НЕВЕРНЫЙ ФАЙЛ. ВНИМАТЕЛЬНО ИЗУЧИТЕ ОТЧЕТ НА ПРЕДМЕТ КРИТИЧЕСКИХ СБОЕВ.'); } }
        function checkStage11() { if(document.getElementById('answer11').value.trim().toUpperCase() === 'OMEGA-LOCKDOWN') { questData.hexCommand = 'OMEGA-LOCKDOWN'; handleCorrectAnswer(); } else { alert('НЕВЕРНАЯ КОМАНДА.'); } }
        function checkStage12() { if(document.getElementById('answer12').value.trim() === '/opt/aurora/diag_tool') { questData.vulnerableFile = '/opt/aurora/diag_tool'; handleCorrectAnswer(); } else { alert('НЕВЕРНЫЙ ПУТЬ К ФАЙЛУ. ВЕКТОР АТАКИ ОСТАЕТСЯ ОТКРЫТЫМ.'); } }
        function checkStage13() { if(document.getElementById('answer13').value.trim() === 'backup_access_key_Alpha7!') { questData.sqlValue = 'backup_access_key_Alpha7!'; handleCorrectAnswer(); } else { alert('ДАННЫЕ НЕВЕРНЫ.'); } }
        function checkStage14() { if(document.getElementById('answer14').value.trim() === '80') { questData.asmResult = 80; handleCorrectAnswer(); } else { alert('НЕВЕРНЫЙ РЕЗУЛЬТАТ. ПРОВЕРЬТЕ ВЫЧИСЛЕНИЯ.'); } }
        function checkStage15() { if(document.getElementById('answer15').value.trim().toLowerCase() === 'j.holloway') { questData.attackerUser = 'j.holloway'; handleCorrectAnswer(); } else { alert('НЕВЕРНОЕ ИМЯ ПОЛЬЗОВАТЕЛЯ. ПРОВЕРЬТЕ ЦЕПОЧКУ СОБЫТИЙ В ЛОГАХ.'); } }
        function checkStage17() { const finalCode = `${questData.memoryKey}-${questData.attackerIP}-${questData.hexCommand}-${questData.attackerUser}`; if(document.getElementById('answer17').value.trim().toUpperCase() === finalCode.toUpperCase()) { handleCorrectAnswer(); } else { alert('МАСТЕР-КЛЮЧ НЕВЕРЕН. ДОСТУП ЗАБЛОКИРОВАН.'); } }

        function startGlitchEffect() {
            const glitchBox = document.getElementById('glitch-box');
            if(!glitchBox) return;
            const targetWord = 'GHOST';
            const chars = 'AZERTYUIOPQSDFGHJKLMWXCVBN0123456789*#$@';
            if (glitchInterval) clearInterval(glitchInterval);
            glitchInterval = setInterval(() => {
                let newText = '';
                for (let i = 0; i < targetWord.length; i++) {
                    newText += Math.random() > 0.6 ? targetWord[i] : chars[Math.floor(Math.random() * chars.length)];
                }
                glitchBox.textContent = newText;
            }, 100);
        }

        function processStage6Tool() {
            const text = document.getElementById('tool-input-6-text').value.toLowerCase();
            const shift = parseInt(document.getElementById('tool-input-6-key').value);
            const output = document.getElementById('tool-output-6');
            if (isNaN(shift)) { output.textContent = 'ОШИБКА: Ключ должен быть числом.'; return; }
            
            let result = '';
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const index = alphabet.indexOf(char);
                if (index !== -1) {
                    let newIndex = (index - shift + 26) % 26;
                    result += alphabet[newIndex];
                } else {
                    result += char;
                }
            }
            output.textContent = result;
        }

        function processStage11Tool() {
            const hex = document.getElementById('tool-input-11').value.replace(/\s/g, '');
            const output = document.getElementById('tool-output-11');
            let str = '';
            if (hex.length % 2 !== 0) {
                 output.textContent = 'ОШИБКА: Неверная длина HEX-строки.'; return;
            }
            try {
                for (let i = 0; i < hex.length; i += 2) {
                    str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
                }
                output.textContent = str;
            } catch (e) {
                output.textContent = 'ОШИБКА: Неверные символы в HEX-строке.';
            }
        }
        
        // --- STAGE 16: Reaper Protocol v2.0 Logic ---
        function initStage16() {
            gameState = {
                agent: { status: 'SHIELDED', health: 100, adaptation: 'NONE' },
                player: { energy: 100 },
                gameOver: false
            };
            const log = document.getElementById('stage16-log');
            if(log) log.innerHTML = '';

            // BUG FIX: Re-enable buttons on restart
            document.querySelectorAll('#stage16-actions button').forEach(btn => btn.disabled = false);

            updateGameDisplay();
            logToStage16('Протокол "Жнец" v2.0 активирован. Цель обнаружена.', 'warn');
        }
        
        function updateGameDisplay() {
            document.getElementById('agent-status').textContent = gameState.agent.status + (gameState.agent.adaptation !== 'NONE' ? ` (ADAPTED: ${gameState.agent.adaptation})` : '');
            document.getElementById('agent-health').textContent = `${gameState.agent.health}%`;
            document.getElementById('player-energy').textContent = gameState.player.energy;

            if (gameState.gameOver) {
                 document.querySelectorAll('#stage16-actions button').forEach(btn => btn.disabled = true);
            }
        }

        function logToStage16(message, type = 'info') {
            const log = document.getElementById('stage16-log');
            if(log) log.innerHTML += `<p class="log-entry ${type}">> ${message}</p>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function spendEnergy(cost) {
            if (gameState.player.energy < cost) {
                logToStage16(`Недостаточно энергии! Требуется: ${cost}, Доступно: ${gameState.player.energy}`, 'error');
                return false;
            }
            gameState.player.energy -= cost;
            return true;
        }

        function performAgentAction(action) {
            if (gameState.gameOver) return;

            switch(action) {
                case 'overload':
                    if (!spendEnergy(30)) return;
                    if (gameState.agent.status === 'SHIELDED') {
                        gameState.agent.status = 'VULNERABLE';
                        logToStage16('Щиты перегружены. Агент уязвим!', 'success');
                    } else {
                        logToStage16('Действие неэффективно. Щиты уже отключены.', 'error');
                    }
                    break;
                
                case 'analyze':
                    if (!spendEnergy(10)) return;
                    let vulnerability = 'АЛЬФА';
                    if (gameState.agent.adaptation === 'ALPHA') { vulnerability = 'БЕТА'; }
                    logToStage16(`АНАЛИЗ: Обнаружена уязвимость к эксплойту типа ${vulnerability}.`, 'info');
                    break;

                case 'execute_alpha':
                case 'execute_beta':
                    const exploitType = (action === 'execute_alpha') ? 'ALPHA' : 'BETA';
                    if (!spendEnergy(25)) return;

                    if (gameState.agent.status === 'SHIELDED') {
                        logToStage16('КОНТРАТАКА: Атака по щиту вызвала ответный импульс! Энергия -20.', 'danger-text');
                        gameState.player.energy -= 20;
                    } else if (gameState.agent.adaptation === exploitType) {
                        logToStage16(`Броня адаптирована к ${exploitType}. Атака неэффективна.`, 'error');
                    } else {
                        gameState.agent.health -= 50;
                        gameState.agent.adaptation = exploitType;
                        if(gameState.agent.health < 0) gameState.agent.health = 0;
                        logToStage16(`Попадание эксплойтом ${exploitType}! Целостность агента: ${gameState.agent.health}%.`, 'success');
                        
                        if (gameState.agent.health > 0) {
                            logToStage16(`Агент адаптируется к атаке типа ${exploitType}...`, 'warn');
                            setTimeout(() => {
                               gameState.agent.status = 'SHIELDED';
                               logToStage16('Агент восстановил щиты!');
                               updateGameDisplay();
                            }, 1500);
                        }
                    }
                    break;

                case 'recharge':
                    if (!spendEnergy(0)) return; // Check for energy just in case, cost is 0
                    gameState.player.energy += 15;
                    if (gameState.player.energy > 100) gameState.player.energy = 100;
                    logToStage16('Перенаправление энергии... Заряд +15.', 'info');
                    break;

                case 'purge':
                    if (gameState.agent.health <= 0) {
                        logToStage16('Протокол "Жнец" выполнен. Агент стерт. Система чиста.', 'success');
                        gameState.gameOver = true;
                        setTimeout(handleCorrectAnswer, 1500);
                    } else {
                        logToStage16('Очистка невозможна. Агент все еще активен.', 'error');
                    }
                    break;
            }

            if (gameState.player.energy <= 0 && !gameState.gameOver) {
                gameState.player.energy = 0;
                logToStage16('КРИТИЧЕСКИЙ СБОЙ: Энергия на нуле. Миссия провалена. Перезапуск протокола...', 'danger-text');
                gameState.gameOver = true;
                setTimeout(initStage16, 3000);
            }
            
            updateGameDisplay();
        }
        
        function showFinalScreen() {
            hideAll();
            populateQuestData(17);
            const stage = document.getElementById('final-screen');
            const template = document.getElementById('final-screen-template');
            if (template) stage.innerHTML = template.innerHTML;

            const reportContainer = document.getElementById('final-report-container');
            
            const reportData = [
                { label: 'Ключ сессии:', value: questData.memoryKey },
                { label: 'IP-адрес "Цербера":', value: questData.attackerIP },
                { label: 'Команда HEX:', value: questData.hexCommand },
                { label: 'Ключевой инсайдер:', value: questData.attackerUser },
                { label: 'Цель:', value: "ПРОТОКОЛ ОМЕГА" },
                { label: 'Статус:', value: "ГОТОВ К ВЫПОЛНЕНИЮ" },
            ];
            
            reportData.forEach((item, index) => {
                setTimeout(() => {
                    const reportItem = document.createElement('div');
                    reportItem.className = 'report-item';
                    reportItem.innerHTML = `<span class="label">${item.label}</span><span class="data"></span><span class="status">[...]</span>`;
                    if (reportContainer) reportContainer.appendChild(reportItem);

                    setTimeout(() => reportItem.classList.add('visible'), 50);
                    
                    setTimeout(() => {
                       const dataSpan = reportItem.querySelector('.data');
                       const statusSpan = reportItem.querySelector('.status');
                       if(!dataSpan || !statusSpan) return;
                       animateTextScramble(dataSpan, item.value || '??????', () => {
                           statusSpan.textContent = '[OK]';
                           statusSpan.classList.add('confirmed');
                       });
                    }, 250);
                }, index * 400);
            });
            
            const finalLink = document.getElementById('final-link');
            if (finalLink) finalLink.href = finalUrl;
            stage.style.display = 'flex';
            setTimeout(() => { stage.classList.add('visible'); }, 10);
        }

        function animateTextScramble(element, final_text, onComplete) { let i = 0; const scramble_chars = 'ABCDEF0123456789?#@%*<>'; const interval = setInterval(() => { let current_text = ''; let allDone = true; for(let j=0; j<final_text.length; j++) { if(j <= i) { current_text += final_text[j]; } else { current_text += scramble_chars[Math.floor(Math.random() * scramble_chars.length)]; allDone = false; } } element.textContent = current_text; if(allDone) { clearInterval(interval); if(onComplete) onComplete(); } i++; }, 50); }

        function startBootAnimation() {
            const bootText = ["ПОДКЛЮЧЕНИЕ К СИМУЛЯЦИОННОМУ УЗЛУ...", "ЗАГРУЗКА ИИ-ИНСТРУКТОРА 'ПРОМЕТЕЙ'...", "КОМПИЛЯЦИЯ СЦЕНАРИЯ АТТЕСТАЦИИ [ОМЕГА]...", "ПРОВЕРКА ЦЕЛОСТНОСТИ ДАННЫХ...", "СИМУЛЯЦИЯ ГОТОВА. УДАЧИ, ХАКЕР."];
            let line = 0; const el = document.getElementById('preloader-text');
            const interval = setInterval(() => {
                if (line < bootText.length) { el.innerHTML += bootText[line] + "\n"; line++; } 
                else { clearInterval(interval); setTimeout(() => { const preloader = document.getElementById('preloader'); preloader.style.opacity = '0'; setTimeout(() => { preloader.style.display = 'none'; startSimulation(); initDevConsole(); }, 800); }, 1000); }
            }, 600);
        }
        
        window.onload = startBootAnimation;
        // Hotkey for dev console
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                toggleDevConsole();
            }
        });
    </script>
</body>
</html>
